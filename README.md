# Image Compression Tool

Мощное приложение для сжатия изображений с интерактивным сравнением результатов. Приложение позволяет рекурсивно обрабатывать папки с фотографиями, сжимать их с настраиваемыми параметрами и сравнивать результаты.

## Основные возможности

### Сжатие изображений
- **Рекурсивная обработка папок**: Автоматически обрабатывает все изображения в выбранной папке и подпапках
- **Настраиваемые параметры сжатия**:
  - Качество JPEG/WebP/AVIF (1-100%)
  - Максимальный размер по наибольшей стороне
  - Максимальный размер по наименьшей стороне
  - Выбор формата вывода (JPEG, WebP, AVIF)
- **Сохранение структуры папок**: Опция для сохранения или уплощения структуры папок
- **Поддержка форматов**: JPEG, PNG, BMP, TIFF, WebP
- **Параллельная обработка**: Настраиваемое количество потоков для ускорения сжатия
- **Статистика сжатия**: Показывает размер до/после, процент сжатия, экономию места

### Сравнение изображений
- **Сравнение оригинал vs сжатое**: Автоматическое сопоставление оригинальных и сжатых изображений
- **Интерактивное сравнение**: Перетаскиваемый слайдер для сравнения левой и правой части изображений
- **Просмотр настроек сжатия**: Отображение всех параметров сжатия и метаданных
- **Сохранение настроек**: Автоматическое создание файла с настройками сжатия и парами изображений
- **Масштабирование**: 
  - Ctrl + Колесо мыши: Увеличение/уменьшение
  - Колесо мыши: Вертикальная прокрутка
  - Shift + Колесо мыши: Горизонтальная прокрутка
- **Панорамирование**: Перетаскивание для навигации по увеличенным изображениям
- **Карусель миниатюр**: Горизонтальная прокрутка всех пар изображений
- **Тонкий слайдер**: Минималистичный интерфейс без видимых линий

## Установка

1. Убедитесь, что у вас установлен Python 3.12 или новее
2. Установите зависимости:

```bash
pip install -r requirements.txt
```

## Использование

### Запуск приложения

```bash
python main.py
```

### Процесс работы

1. **Выбор папки**: Нажмите "Select Input Directory" и выберите папку с изображениями
2. **Настройка параметров**:
   - **JPEG Quality**: Качество сжатия (рекомендуется 70-90)
   - **Max Largest Side**: Максимальный размер наибольшей стороны в пикселях
   - **Max Smallest Side**: Максимальный размер наименьшей стороны в пикселях
   - **Output Format**: Формат вывода (JPEG, WebP, AVIF)
   - **Preserve folder structure**:
     - ✅ Включено: Сохраняет структуру папок (например, `Photos/Vacation/IMG_001.jpg` → `Photos_compressed/Vacation/IMG_001.jpg`)
     - ❌ Выключено: Все файлы помещаются в одну папку (например, `Photos/Vacation/IMG_001.jpg` → `Photos_compressed/IMG_001.jpg`)
   - **Copy unsupported files**:
     - ✅ Включено: копирует файлы неподдерживаемых форматов в выходную папку
     - ❌ Выключено: файлы неподдерживаемых форматов игнорируются
   - **Copy unsupported files to separate folder**:
     - ✅ Включено: копирует неподдерживаемые файлы в отдельную папку (суффикс `_не_обработано`)
3. **Запуск сжатия**: Нажмите "Start Compression" (повторное нажатие прерывает процесс)
4. **Просмотр результатов**: После завершения нажмите "Compare Images"

### Использование в коде

```python
from service.image_compression import ImageCompressor

# By default uses all available CPU cores
compressor = ImageCompressor()
compressor.process_directory(input_path, output_path)

# Or specify a custom worker count
# compressor.process_directory(input_path, output_path, num_workers=4)
```

### Сравнение изображений

После сжатия вы можете:
- **Перетаскивать желтый слайдер** для настройки разделения между изображениями
- **Использовать Ctrl + колесо мыши** для масштабирования
- **Кликать на миниатюры** в карусели для переключения между парами
- **Нажать "Reset View"** для возврата к исходному масштабу
- **Нажать "View Settings"** для просмотра параметров сжатия

## Структура файлов

```
photoViewer Cursor/
├── main.py                    # Основной файл приложения
├── image_compression.py       # Модуль сжатия изображений
├── image_comparison.py        # Модуль сравнения изображений
├── requirements.txt           # Зависимости Python
└── README.md                 # Этот файл
```

## Технические детали

### Настройки памяти

Количество одновременно загруженных полноразмерных изображений и миниатюр
управляется файлом `cache_config.toml` в корне проекта. Параметры
`max_loaded_images` и `max_loaded_previews` задают ограничения на количество
соответствующих объектов в памяти. Значение `0` отключает ограничение.

### Модули

- **ImageCompressor**: Обработка и сжатие изображений с использованием Pillow
- **CompressionWorker**: Фоновая обработка для предотвращения блокировки UI
- **ComparisonViewer**: Интерактивный виджет для сравнения изображений
- **ThumbnailCarousel**: Карусель миниатюр для навигации

### Поддерживаемые форматы

- **Входные**: JPEG, PNG, BMP, TIFF, WebP, AVIF, HEIC, HEIF, GIF, ICO, PPM, PGM, PBM
- **Выходные**: JPEG, WebP, AVIF (с настраиваемым качеством)

### Алгоритм сжатия

1. **Анализ размеров**: Проверка необходимости изменения размера
2. **Пропорциональное масштабирование**: Сохранение соотношения сторон
3. **Качественное сжатие**: Применение настроек качества для JPEG
4. **Оптимизация**: Использование встроенных алгоритмов оптимизации

## Требования

- Python 3.12+
- PySide6 6.4.0+
- Pillow 10.0.0+
- pillow-avif-plugin 1.3.1+ (для поддержки AVIF)
- pillow-heif 0.14.0+ (для поддержки HEIC/HEIF)

## Особенности

- **Модульная архитектура**: Разделение функциональности на независимые модули
- **Асинхронная обработка**: Сжатие в фоновом потоке без блокировки интерфейса
- **Современный UI**: Темная тема для сравнения, светлая для основного приложения
- **Подробное логирование**: Отслеживание процесса сжатия в реальном времени
- **Обработка ошибок**: Корректная обработка проблем с файлами и форматами
- **Сохранение настроек**: Автоматическое создание JSON-файла с параметрами сжатия
- **Инвертированная прокрутка**: Естественное направление прокрутки в режиме просмотра

## Пример использования

1. Выберите папку с фотографиями (например, "Vacation_Photos")
2. Установите качество 85%, максимальную сторону 1920px, минимальную 1080px
3. Запустите сжатие
4. Получите папку "Vacation_Photos_compressed" со сжатыми изображениями
5. Откройте сравнение для оценки качества сжатия
